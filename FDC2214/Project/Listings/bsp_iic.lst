C51 COMPILER V9.56.0.0   BSP_IIC                                                           07/23/2018 13:50:01 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE BSP_IIC
OBJECT MODULE PLACED IN .\Objects\bsp_iic.obj
COMPILER INVOKED BY: D:\Program Files\Keil_v5\C51\BIN\C51.EXE ..\bsp\scr\bsp_iic.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\bs
                    -p\inc) DEBUG OBJECTEXTEND PRINT(.\Listings\bsp_iic.lst) TABS(2) OBJECT(.\Objects\bsp_iic.obj)

line level    source

   1          #include "bsp.h"
   2          
   3          uint8 dis[6];         //显示数字(-511至512)的字符数组
   4          int dis_data;         //变量
   5          //********************************************************************************
   6          //整数转字符串  配合串口发送
   7          //********************************************************************************
   8          void lcd_printf(uint8 *s,int temp_data)
   9          {
  10   1        if(temp_data<0)
  11   1        {
  12   2          temp_data=-temp_data;
  13   2          *s='-';
  14   2        }
  15   1        else *s=' ';
  16   1      
  17   1        *++s =temp_data/10000+0x30;
  18   1        temp_data=temp_data%10000;     //取余运算
  19   1      
  20   1        *++s =temp_data/1000+0x30;
  21   1        temp_data=temp_data%1000;     //取余运算
  22   1      
  23   1        *++s =temp_data/100+0x30;
  24   1        temp_data=temp_data%100;     //取余运算
  25   1        *++s =temp_data/10+0x30;
  26   1        temp_data=temp_data%10;      //取余运算
  27   1        *++s =temp_data+0x30;   
  28   1      }
  29          //*************************************************************************************************
  30          //I2C起始信号
  31          //*************************************************************************************************
  32          void I2C_Start()
  33          {
  34   1          SDA = 1;                    //拉高数据线
  35   1          SCL = 1;                    //拉高时钟线
  36   1          Delay5us();                 //延时
  37   1          SDA = 0;                    //产生下降沿
  38   1          Delay5us();                 //延时
  39   1          SCL = 0;                    //拉低时钟线
  40   1      }
  41          //*************************************************************************************************
  42          //I2C停止信号
  43          //*************************************************************************************************
  44          void I2C_Stop()
  45          {
  46   1          SDA = 0;                    //拉低数据线
  47   1          SCL = 0;
  48   1          Delay5us();
  49   1          SCL = 1;                    //拉高时钟线
  50   1          Delay5us();                 //延时
  51   1          SDA = 1;                    //产生上升沿
  52   1          //Delay5us();                 //延时
  53   1      }
  54          //**************************************************************************************************
C51 COMPILER V9.56.0.0   BSP_IIC                                                           07/23/2018 13:50:01 PAGE 2   

  55          //I2C发送应答信号
  56          //入口参数:ack (0:ACK 1:NAK)
  57          //**************************************************************************************************
  58          void I2C_SendACK(bit ack)
  59          {
  60   1          SDA = ack;                  //写应答信号
  61   1          SCL = 1;                    //拉高时钟线
  62   1          Delay5us();                 //延时
  63   1          SCL = 0;                    //拉低时钟线
  64   1          Delay5us();                 //延时
  65   1      }
  66          //****************************************************************************************************
  67          //I2C接收应答信号
  68          //****************************************************************************************************
  69          bit I2C_RecvACK()
  70          {
  71   1          SCL = 1;                    //拉高时钟线
  72   1          Delay5us();                 //延时
  73   1          CY = SDA;                   //读应答信号
  74   1          SCL = 0;                    //拉低时钟线
  75   1          Delay5us();                 //延时
  76   1          return CY;
  77   1      }
  78          //*****************************************************************************************************
  79          //向I2C总线发送一个字节数据
  80          //*****************************************************************************************************
  81          void I2C_SendByte(uint8 dat)
  82          {
  83   1          uint8 i;
  84   1          for (i=0; i<8; i++)         //8位计数器
  85   1          {
  86   2              dat <<= 1;              //移出数据的最高位
  87   2              SDA = CY;               //送数据口
  88   2              SCL = 1;                //拉高时钟线
  89   2              Delay5us();             //延时
  90   2              SCL = 0;                //拉低时钟线
  91   2              Delay5us();             //延时
  92   2          }
  93   1          I2C_RecvACK();
  94   1      }
  95          //*****************************************************************************************************
  96          //从I2C总线接收一个字节数据
  97          //******************************************************************************************************
  98          uint8 I2C_RecvByte()
  99          {
 100   1          uint8 i;
 101   1          uint8 dat = 0;
 102   1          SDA = 1;                    //使能内部上拉,准备读取数据,
 103   1          for (i=0; i<8; i++)         //8位计数器
 104   1          {
 105   2              dat <<= 1;
 106   2              SCL = 1;                //拉高时钟线
 107   2              Delay5us();             //延时
 108   2              dat |= SDA;             //读数据               
 109   2              SCL = 0;                //拉低时钟线
 110   2              Delay5us();             //延时
 111   2          }
 112   1          return dat;
 113   1      }
 114          
 115          
 116          /*******************************************************************************
C51 COMPILER V9.56.0.0   BSP_IIC                                                           07/23/2018 13:50:01 PAGE 3   

 117          * 函数名  : WriteRegfdc2214 
 118          * 描述      : 写寄存器数据
 119          * 输入参数  : add，value
 120          * 返回参数  : 无
 121          *******************************************************************************/
 122          void WriteRegfdc2214(unsigned char add,unsigned int value)
 123          {
 124   1          I2C_Start(); 
 125   1          I2C_SendByte(0X54);  //ADDR=0时，地址0X2A<<1+0=0X54  
 126   1          I2C_SendByte(add);      //写地址
 127   1          I2C_SendByte(value>>8); //
 128   1          I2C_SendByte(value&0xff);//写低8位
 129   1          I2C_Stop();               //产生一个停止条件 
 130   1          delay_ms(10);  
 131   1      }
 132          /*******************************************************************************
 133          * 函数名  : ReadRegLDC 
 134          * 描述      : 读寄存器数据
 135          * 输入参数  : add地址
 136          * 返回参数  : 无
 137          *******************************************************************************/
 138          unsigned int ReadRegfdc2214(unsigned char add)
 139          {
 140   1          unsigned int status;
 141   1          unsigned int a,b;
 142   1          I2C_Start(); 
 143   1          I2C_SendByte(0X54);    //写命令ADDR=0
 144   1          I2C_SendByte(add);     //
 145   1          I2C_Start();            //重新开始
 146   1          I2C_SendByte(0X55);    //发送读命令ADDR=0
 147   1          
 148   1          a=I2C_RecvByte();     //读高位
 149   1        I2C_SendACK(0); 
 150   1          b=I2C_RecvByte();    //读低位
 151   1        I2C_SendACK(1); 
 152   1          status=(a<<8)+b;
 153   1          I2C_Stop();
 154   1          return (status);
 155   1      }
 156          /*******************************************************************************
 157          * 函数名  : InitSingleLDC1314 
 158          * 描述      : 初始化单通道
 159          * 输入参数  : 无
 160          * 返回参数  : 无
 161          *******************************************************************************/
 162          void InitSinglefdc2214(void)
 163          {
 164   1          WriteRegfdc2214(0x08,0x34FB);
 165   1          WriteRegfdc2214(0x09,0x34FB);
 166   1          WriteRegfdc2214(0x0A,0x34FB);
 167   1          WriteRegfdc2214(0x0B,0x34FB);//设置转换时间  设置达到最高精度
 168   1        
 169   1          WriteRegfdc2214(0x10,0x001B);
 170   1          WriteRegfdc2214(0x11,0x001B);
 171   1          WriteRegfdc2214(0x12,0x001B);
 172   1          WriteRegfdc2214(0x13,0x001B);//FDC2214_SETTLECOUNT_CH0~3 计数
 173   1      
 174   1          WriteRegfdc2214(0x14,0x2002); 
 175   1          WriteRegfdc2214(0x15,0x2002);
 176   1          WriteRegfdc2214(0x16,0x2002);
 177   1          WriteRegfdc2214(0x17,0x2002);//分频洗系数
 178   1      
C51 COMPILER V9.56.0.0   BSP_IIC                                                           07/23/2018 13:50:01 PAGE 4   

 179   1          WriteRegfdc2214(0x19,0x0000); //ERROE_CONFIG
 180   1        
 181   1          WriteRegfdc2214(0x1B,0xC20D); //通道配置
 182   1        
 183   1          WriteRegfdc2214(0x1E,0x7800); 
 184   1          WriteRegfdc2214(0x1F,0x7800);
 185   1          WriteRegfdc2214(0x20,0x7800);
 186   1          WriteRegfdc2214(0x21,0x7800);//配置驱动电流
 187   1          
 188   1          WriteRegfdc2214(0x1A,0x1401);//配置寄存器
 189   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    666    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8      19
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
